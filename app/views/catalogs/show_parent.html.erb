<!-- Header render -->
<%= render :partial => "partials/head" %>
<!-- /Header render -->

<!-- Catalog wrapper -->
<div id="catalog-page-wrapper" class="f-height catalog-page-index">
  <div class="g12 pd-me">
    <h1>Каталог продукції</h1>
  </div>
  <div class="catalog-block g4 alpha">
    <%= render :partial => "partials/catalog_navigation" %>
  </div><!-- Catalog wrap stuff G4 -->
  <!-- Lets count have many childs we got -->
  <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
      var child_count = <%= fetch_all_child(@parent_catalog.id).count %>;
      var child_width = child_count * 217;
      console.log('Height of tabs is '+child_width);

      $(".child-tabs").css({
        width: child_width
      });
    });
  </script>
  <div id="catalog-content">
  <div id="catalog-parent" class="g8 catalog-page-format omega">
    <h1><%= @parent_catalog.name %></h1>
    <div id="tab-control">
      <!--<div class="tabs-left animate"> < </div>-->
      <!--<div class="tabs-right animate"> > </div>-->
      <div class="tabs">
        <% fetch_all_child(@parent_catalog.id).each do |child_tabs| %>
          <div class="tab-item" id="tab-<%= child_tabs.id %>" data-child-name="<%= child_tabs.name %>" data-slug="<%= child_tabs.slug %>">
            <% link_child = catalog_main_path+'/'+@parent_catalog.catalog.slug+'/'+@parent_catalog.slug+'/'+child_tabs.slug %>
            <% if child_tabs.avatar.present? %>
              <%= link_to (image_tag(child_tabs.avatar.url(:tab), :alt => child_tabs.name)), link_child %>
              <% else %>
              <%= link_to child_tabs.name, link_child %>
            <% end %>
          </div>
        <% end %>
      </div>
    
    <div id="tabcontents">

      <div class="tab-content-wrapper" id="tab-content-<%= get_first_child(@parent_catalog.id).id %>">
        <%= get_first_child(@parent_catalog.id).description.html_safe unless get_first_child(@parent_catalog.id).description.blank? %>

      <div id="all-products-by-childs">
      <div class="store-section"><!-- Online store -->
        <div class="top-border">&nbsp;</div>
          <% fetch_all_products(get_first_child(@parent_catalog.id).id).each do |pr| %>
              <div class="online-item" data-id="" data-catalog-name="" data-price="">
                <%= image_tag(pr.avatar.url(:thumb), :alt => pr.name) %>
                <p><%= pr.name %></p>
                <%= link_to 'Детальніше', catalog_main_path+'/'+parent_slug(get_first_child(@parent_catalog.id).id)+'/'+get_first_child(@parent_catalog.id).slug+'/'+pr.slug, :title => pr.name, :class => 'submit-branded animate' %>
              </div>
          <% end %>
      </div> <!-- /Online store -->
      </div> <!-- /products -->
    </div>
  </div>
</div><!-- /tab-control -->
    
  </div>

</div> <!-- / div#catalog-content -->

</div>
<!-- /Catalog wrapper -->

<script type="text/javascript">
        function openChild(url){

          var $tab=$('#tab-control .tabs .tab-item a[href*="'+'url'+'"]').parent();
          var $tabs=$tab.parent().find('.tab-item');
          console.log('required:'+url);
          $.ajax({
            url:url+'.xml',
            dataType:'xml',
            success:function(xml){
              var $xml=$(xml);
              var description=$('child-catalog description',$xml).text();
              if(description!='')
                $('#tab-control #tabcontents .tab-content-wrapper').html(description);
              else
                $('#tab-control #tabcontents .tab-content-wrapper').html('page is empty');
                //var $catalog_content=$('div#catalog-content');
                //var $catalog_parent=$catalog_content.find('div#catalog-parent');                 

                $tabs.filter('.active').removeClass('active');
                $tab.addClass('active');

                $('div.catalog-block').find('a.active').removeClass('active');
                $('div.catalog-block').find('a[href*="'+url+'"]').addClass('active');

                // add url handler

                window.history.pushState('child','',url);
          }
        });
        }
        window.onpopstate = function(event) {
          console.log("location: " + document.location + ", state: " + JSON.stringify(event.state)+';window.location.pathname:'+window.location.pathname);
          var url=window.location.pathname;
          //consol
          if(event.state=='child'){
            openChild(url);
          }
        };
        $('#tab-control .tabs .tab-item a').click(function(event){
          event.preventDefault();
          var uri=$(this).uri();
          var required_uri=uri.pathname();
          openChild(required_uri);
        });
        $('div.catalog-block div.catalog-item>ul>li>ul>li>a').click(function(event){
          event.preventDefault();
          var uri=$(this).uri();
          var required_uri=uri.pathname();
          //alert(required_uri);
          openChild(required_uri);
        });
</script>


<div class="pd-me f-height"></div>

<!-- Sponsor render -->
<%= render :partial => "partials/sponsor-all" %>
<!-- Sponsor render -->

<!-- Footer render -->
<%= render :partial => "partials/footer" %>
<!-- /Footer render -->
